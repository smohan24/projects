<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
    <title>Aggregation Framework Examples — MongoDB Manual</title>

    <link rel="shortcut icon" href="http://media.mongodb.org/favicon.ico">
    <meta name="robots" content="index">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="canonical" href="http://docs.mongodb.org/manual/tutorial/aggregation-examples">

    
    
    <link rel="stylesheet" href="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/mongodb-docs.css" type="text/css">
    <link rel="stylesheet" href="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/pygments.css" type="text/css">
      
    <script id="undefined" src="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/inpage_linkid.js" async="" type="text/javascript"></script><script src="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/ga.js" async="" type="text/javascript"></script><script src="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/cse.js" async="" type="text/javascript"></script><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.2.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/jquery.js"></script>
    <script type="text/javascript" src="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/underscore.js"></script>
    <script type="text/javascript" src="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/doctools.js"></script>
      <link rel="search" type="application/opensearchdescription+xml" href="http://docs.mongodb.org/osd.xml" title="MongoDB Help">
<link rel="author" title="About these documents" href="http://docs.mongodb.org/manual/about/">
<link rel="top" title="MongoDB Manual" href="http://docs.mongodb.org/manual/">
<link rel="up" title="Aggregation" href="http://docs.mongodb.org/manual/aggregation/">
<link rel="next" title="Aggregation Framework Reference" href="http://docs.mongodb.org/manual/reference/aggregation/">
<link rel="prev" title="Aggregation Framework" href="http://docs.mongodb.org/manual/applications/aggregation/">
<!-- Put the following javascript before the closing </head> tag. -->
<script>
  (function() {
    var cx = '017213726194841070573:WMX6838984';
    var gcse = document.createElement('script'); gcse.type = 'text/javascript'; gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(gcse, s);
  })();
</script>
  <script type="text/javascript" src="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/jsapi"></script><link rel="stylesheet" href="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/defaulten.css" type="text/css"><link rel="stylesheet" href="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/default.css" type="text/css"><script src="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/defaulten.js" type="text/javascript"></script><script src="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/search.js" type="text/javascript"></script><style type="text/css">
.gsc-control-cse {
font-family: Arial, sans-serif;
border-color: #FFFFFF;
background-color: #FFFFFF;
}
.gsc-control-cse .gsc-table-result {
font-family: Arial, sans-serif;
}
input.gsc-input, .gsc-input-box, .gsc-input-box-hover, .gsc-input-box-focus {
border-color: #D9D9D9;
}
input.gsc-search-button, input.gsc-search-button:hover, input.gsc-search-button:focus {
border-color: #5AAC41;
background-color: #5AAC41;
background-image: none;
filter: none;
}
.gsc-tabHeader.gsc-tabhInactive {
border-color: #CCCCCC;
background-color: #FFFFFF;
}
.gsc-tabHeader.gsc-tabhActive {
border-color: #CCCCCC;
border-bottom-color: #FFFFFF;
background-color: #FFFFFF;
}
.gsc-tabsArea {
border-color: #CCCCCC;
}
.gsc-webResult.gsc-result,
.gsc-results .gsc-imageResult {
border-color: #FFFFFF;
background-color: #FFFFFF;
}
.gsc-webResult.gsc-result:hover,
.gsc-imageResult:hover {
border-color: #FFFFFF;
background-color: #FFFFFF;
}
.gs-webResult.gs-result a.gs-title:link,
.gs-webResult.gs-result a.gs-title:link b,
.gs-imageResult a.gs-title:link,
.gs-imageResult a.gs-title:link b {
color: #1155CC;
}
.gs-webResult.gs-result a.gs-title:visited,
.gs-webResult.gs-result a.gs-title:visited b,
.gs-imageResult a.gs-title:visited,
.gs-imageResult a.gs-title:visited b {
color: #1155CC;
}
.gs-webResult.gs-result a.gs-title:hover,
.gs-webResult.gs-result a.gs-title:hover b,
.gs-imageResult a.gs-title:hover,
.gs-imageResult a.gs-title:hover b {
color: #1155CC;
}
.gs-webResult.gs-result a.gs-title:active,
.gs-webResult.gs-result a.gs-title:active b,
.gs-imageResult a.gs-title:active,
.gs-imageResult a.gs-title:active b {
color: #1155CC;
}
.gsc-cursor-page {
color: #1155CC;
}
a.gsc-trailing-more-results:link {
color: #1155CC;
}
.gs-webResult .gs-snippet,
.gs-imageResult .gs-snippet,
.gs-fileFormatType {
color: #333333;
}
.gs-webResult div.gs-visibleUrl,
.gs-imageResult div.gs-visibleUrl {
color: #009933;
}
.gs-webResult div.gs-visibleUrl-short {
color: #009933;
}
.gs-webResult div.gs-visibleUrl-short {
display: none;
}
.gs-webResult div.gs-visibleUrl-long {
display: block;
}
.gs-promotion div.gs-visibleUrl-short {
display: none;
}
.gs-promotion div.gs-visibleUrl-long {
display: block;
}
.gsc-cursor-box {
border-color: #FFFFFF;
}
.gsc-results .gsc-cursor-box .gsc-cursor-page {
border-color: #CCCCCC;
background-color: #FFFFFF;
color: #1155CC;
}
.gsc-results .gsc-cursor-box .gsc-cursor-current-page {
border-color: #CCCCCC;
background-color: #FFFFFF;
color: #1155CC;
}
.gsc-webResult.gsc-result.gsc-promotion {
border-color: #F6F6F6;
background-color: #F6F6F6;
}
.gsc-completion-title {
color: #1155CC;
}
.gsc-completion-snippet {
color: #333333;
}
.gs-promotion a.gs-title:link,
.gs-promotion a.gs-title:link *,
.gs-promotion .gs-snippet a:link {
color: #1155CC;
}
.gs-promotion a.gs-title:visited,
.gs-promotion a.gs-title:visited *,
.gs-promotion .gs-snippet a:visited {
color: #1155CC;
}
.gs-promotion a.gs-title:hover,
.gs-promotion a.gs-title:hover *,
.gs-promotion .gs-snippet a:hover {
color: #1155CC;
}
.gs-promotion a.gs-title:active,
.gs-promotion a.gs-title:active *,
.gs-promotion .gs-snippet a:active {
color: #1155CC;
}
.gs-promotion .gs-snippet,
.gs-promotion .gs-title .gs-promotion-title-right,
.gs-promotion .gs-title .gs-promotion-title-right * {
color: #333333;
}
.gs-promotion .gs-visibleUrl,
.gs-promotion .gs-visibleUrl-short {
color: #009933;
}
.gsc-input input.gsc-input {
background: none repeat scroll 0% 0% white !important;
}
</style><style type="text/css">.gsfe_a{border:1px solid #b9b9b9;border-top-color:#a0a0a0;box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);-moz-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);-webkit-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);}.gsfe_b{border:1px solid #4d90fe;outline:none;box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);-moz-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);-webkit-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);}.gssb_c{border:0;position:absolute;z-index:989}.gssb_e{border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-moz-box-shadow:0 2px 4px rgba(0,0,0,0.2);cursor:default}.gssb_f{visibility:hidden;white-space:nowrap}.gssb_k{border:0;display:block;position:absolute;top:0;z-index:988}.gsdd_a{border:none!important}.gsib_a{width:100%;padding:4px 6px 0}.gsib_a,.gsib_b{vertical-align:top}.gssb_a{padding:0 7px}.gssb_a,.gssb_a td{white-space:nowrap;overflow:hidden;line-height:22px}#gssb_b{font-size:11px;color:#36c;text-decoration:none}#gssb_b:hover{font-size:11px;color:#36c;text-decoration:underline}.gssb_g{text-align:center;padding:8px 0 7px;position:relative}.gssb_h{font-size:15px;height:28px;margin:0.2em}.gssb_i{background:#eee}.gss_ifl{visibility:hidden;padding-left:5px}.gssb_i .gss_ifl{visibility:visible}a.gssb_j{font-size:13px;color:#36c;text-decoration:none;line-height:100%}a.gssb_j:hover{text-decoration:underline}.gssb_l{height:1px;background-color:#e5e5e5}.gssb_m{color:#000;background:#fff}.gscsep_a{display:none}.gsq_a{padding:0}.gscb_a{display:inline-block;font:27px/13px arial,sans-serif}.gsst_a .gscb_a{color:#a1b9ed;cursor:pointer}.gsst_a:hover .gscb_a,.gsst_a:focus .gscb_a{color:#36c}.gsst_a{display:inline-block}.gsst_a{cursor:pointer;padding:0 4px}.gsst_a:hover{text-decoration:none!important}.gsst_b{font-size:16px;padding:0 2px;user-select:none;-moz-user-select:none;white-space:nowrap}.gsst_e{opacity:0.55;}.gsst_a:hover .gsst_e,.gsst_a:focus .gsst_e{opacity:0.72;}.gsst_a:active .gsst_e{opacity:1;}.gsst_f{background:white;text-align:left}.gsst_g{background-color:white;border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-moz-box-shadow:0 2px 4px rgba(0,0,0,0.2);margin:-1px -3px;padding:0 6px}.gsst_h{background-color:white;height:1px;margin-bottom:-1px;position:relative;top:-1px}.gssb_a{padding:0 9px}.gsib_a{padding-right:8px;padding-left:8px}.gsst_a{padding-top:3px}.gssb_e{border:0}.gssb_l{margin:5px 0}.gssb_c .gsc-completion-container{position:static}.gssb_c{z-index:5000}.gsc-completion-container table{background:transparent;font-size:inherit;font-family:inherit}.gssb_c > tbody > tr,.gssb_c > tbody > tr > td,.gssb_d,.gssb_d > tbody > tr,.gssb_d > tbody > tr > td,.gssb_e,.gssb_e > tbody > tr,.gssb_e > tbody > tr > td{padding:0;margin:0;border:0}.gssb_a table,.gssb_a table tr,.gssb_a table tr td{padding:0;margin:0;border:0}</style><style type="text/css">.atlwdg-blanket {background:#000;height:100%;left:0;opacity:.5;position:fixed;top:0;width:100%;z-index:1000000;}
.atlwdg-popup {background:#fff;border:1px solid #666;position:fixed;top:50%;left:50%;z-index:10000011;}
.atlwdg-popup.atlwdg-box-shadow {-moz-box-shadow:10px 10px 20px rgba(0,0,0,0.5);-webkit-box-shadow:10px 10px 20px rgba(0,0,0,0.5);box-shadow:10px 10px 20px rgba(0,0,0,0.5);background-color:#fff;}
.atlwdg-hidden {display:none;}
.atlwdg-trigger {position: fixed; background: #013466; padding: 5px;border: 2px solid white;border-top: none; font-weight: bold; color: white; display:block;white-space:nowrap;text-decoration:none; font-family:arial, FreeSans, Helvetica, sans-serif;font-size:12px;box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);-webkit-box-shadow:5px 5px 10px rgba(0, 0, 0, 0.5); -moz-box-shadow:5px 5px 10px rgba(0, 0, 0, 0.5);border-radius: 0 0 5px 5px; -moz-border-radius: 0 0 5px 5px;}
a.atlwdg-trigger {text-decoration:none;}
.atlwdg-trigger.atlwdg-TOP {left: 45%;top:0; }
.atlwdg-trigger.atlwdg-RIGHT {left:100%; top:40%; -webkit-transform-origin:top left; -webkit-transform: rotate(90deg); -moz-transform: rotate(90deg); -moz-transform-origin:top left;-ms-transform: rotate(90deg); -ms-transform-origin:top left; }
.atlwdg-trigger.atlwdg-SUBTLE { right:0; bottom:0; border: 1px solid #ccc; border-bottom: none; border-right: none; background-color: #f5f5f5; color: #444; font-size: 11px; padding: 6px; box-shadow: -1px -1px 2px rgba(0, 0, 0, 0.5); border-radius: 2px 0 0 0; }
.atlwdg-loading {position:absolute;top:220px;left:295px;}</style></head>
  <body>
<div id="top-right">
        <div class="user-right">
                <ul id="header-menu-bar" class="ajs-menu-bar">
                <li class="normal"><a target="_blank" href="http://groups.google.com/group/mongodb-user">Forums</a></li>
                <li class="normal"><a target="_blank" href="http://blog.mongodb.org/">Blog</a></li>
                <li class="normal"><a href="http://www.mongodb.org/downloads">Download</a></li>
                <li class="normal"><a href="http://docs.mongodb.org/ecosystem/drivers/">Drivers</a></li>
                <li class="normal"><a href="http://www.10gen.com/events">Events</a></li>
                <li class="normal last"><a class="last" href="http://docs.mongodb.org/manual/meta/translation">Translations</a></li>
                </ul>
        </div>
</div>
<div id="header-db" class="spread">
        <div class="split">
                <div id="logo">
                        <div><a href="http://docs.mongodb.org/manual/"><img class="logo" src="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/logo-mongodb.png" alt="MongoDB Logo"></a></div>
                </div>
        </div>

<div class="search-db"><div dir="ltr" id="___gcse_0"><form accept-charset="utf-8" class="gsc-search-box gsc-search-box-tools"><table class="gsc-search-box" cellpadding="0" cellspacing="0"><tbody><tr><td class="gsc-input"><div id="gsc-iw-id1" class="gsc-input-box"><table class="gstl_0 " id="gs_id0" style="width: 100%; padding: 0pt;" cellpadding="0" cellspacing="0"><tbody><tr><td class="gsib_a" id="gs_tti0"><input spellcheck="false" dir="ltr" id="gsc-i-id1" style="width: 100%; padding: 0pt; border: medium none; margin: 0pt; height: auto; outline: medium none;" title="search" name="search" class="gsc-input" size="10" autocomplete="off" type="text"></td><td class="gsib_b"><div dir="ltr" id="gs_st0" class="gsst_b"><a style="display: none;" href="javascript:void(0)" class="gsst_a"><span id="gs_cb0" class="gscb_a">×</span></a></div></td></tr></tbody></table></div></td><td class="gsc-search-button"><input title="search" class="gsc-search-button gsc-search-button-v2" src="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/search_box_icon.png" type="image"></td><td class="gsc-clear-button"><div title="clear results" class="gsc-clear-button">&nbsp;</div></td></tr></tbody></table><table class="gsc-branding" cellpadding="0" cellspacing="0"><tbody><tr style="display: none;"><td class="gsc-branding-user-defined"></td><td class="gsc-branding-text"><div class="gsc-branding-text">powered by</div></td><td class="gsc-branding-img"><img class="gsc-branding-img" src="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/small-logo.png"></td></tr></tbody></table></form></div></div>
<div id="etp">
<ul>
<li><a href="https://github.com/mongodb/docs/blob/master/source/tutorial/aggregation-examples.txt" target="_blank" title="Edit tutorial/aggregation-examples.txt on github">Edit this Page</a></li>
<li><a href="http://github.com/mongodb/docs" target="_blank" title="Fork the documentation on GitHub and contribute.">GitHub</a></li>
<li><a href="https://jira.mongodb.org/secure/CreateIssueDetails%21init.jspa?pid=10380&amp;issuetype=4&amp;priority=4&amp;summary=Comment+on%3a+%22tutorial/aggregation-examples%2Etxt%22" target="_blank" title="Report a problem with tutorial/aggregation-examples.txt on Jira">Report a problem</a></li>
</ul>
</div>
</div>  
    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            <div id="cse-results"><div id="___gcse_1"><div class="gsc-control-cse gsc-control-cse-en"><div dir="ltr" class="gsc-control-wrapper-cse"><div class="gsc-results-wrapper-nooverlay"><div class="gsc-tabsAreaInvisible"><div class="gsc-tabHeader gsc-inline-block gsc-tabhActive">Custom Search</div><span class="gs-spacer"> </span></div><div class="gsc-tabsAreaInvisible"></div><div class="gsc-above-wrapper-area-invisible"><table class="gsc-above-wrapper-area-container" cellpadding="0" cellspacing="0"><tbody><tr><td class="gsc-result-info-container"><div class="gsc-result-info-invisible"></div></td></tr></tbody></table></div><div class="gsc-adBlockInvisible"></div><div class="gsc-wrapper"><div class="gsc-adBlockInvisible"></div><div class="gsc-resultsbox-invisible"><div class="gsc-resultsRoot gsc-tabData gsc-tabdActive"><table class="gsc-resultsHeader" cellpadding="0" cellspacing="0"><tbody><tr><td class="gsc-twiddleRegionCell"><div class="gsc-twiddle"><div class="gsc-title">Web</div></div><div class="gsc-stats"></div><div class="gsc-results-selector gsc-all-results-active"><div title="show one result" class="gsc-result-selector gsc-one-result">&nbsp;</div><div title="show more results" class="gsc-result-selector gsc-more-results">&nbsp;</div><div title="show all results" class="gsc-result-selector gsc-all-results">&nbsp;</div></div></td><td class="gsc-configLabelCell"></td></tr></tbody></table><div><div class="gsc-expansionArea"></div></div></div></div></div></div></div></div></div></div>
            
  <div class="section" id="aggregation-framework-examples">
<h1>Aggregation Framework Examples<a class="headerlink" href="#aggregation-framework-examples" title="Permalink to this headline">¶</a></h1>
<p>MongoDB provides flexible data aggregation functionality with the
<a class="reference internal" href="http://docs.mongodb.org/manual/reference/command/aggregate/#aggregate" title="aggregate"><tt class="xref mongodb mongodb-dbcommand docutils literal"><span class="pre">aggregate</span></tt></a> command. For additional information about
aggregation consider the following resources:</p>
<ul class="simple">
<li><a class="reference internal" href="http://docs.mongodb.org/manual/applications/aggregation/"><em>Aggregation Framework</em></a></li>
<li><a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/"><em>Aggregation Framework Reference</em></a></li>
<li><a class="reference internal" href="http://docs.mongodb.org/manual/reference/sql-aggregation-comparison/"><em>SQL to Aggregation Framework Mapping Chart</em></a></li>
</ul>
<p>This document provides a number of practical examples that display the
capabilities of the aggregation framework. All examples use a publicly
available data set of all zipcodes and populations in the United
States.</p>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="http://docs.mongodb.org/manual/reference/mongod/#mongod" title="mongod"><tt class="xref mongodb mongodb-program docutils literal"><span class="pre">mongod</span></tt></a> and <a class="reference internal" href="http://docs.mongodb.org/manual/reference/mongo/#mongo" title="mongo"><tt class="xref mongodb mongodb-program docutils literal"><span class="pre">mongo</span></tt></a>, version 2.2 or later.</p>
</div>
<div class="section" id="aggregations-using-the-zip-code-data-set">
<h2>Aggregations using the Zip Code Data Set<a class="headerlink" href="#aggregations-using-the-zip-code-data-set" title="Permalink to this headline">¶</a></h2>
<p>To run you will need the zipcode data set. These data are available at:
<a class="reference external" href="http://media.mongodb.org/zips.json">media.mongodb.org/zips.json</a>.
Use <a class="reference internal" href="http://docs.mongodb.org/manual/reference/mongoimport/#mongoimport" title="mongoimport"><tt class="xref mongodb mongodb-program docutils literal"><span class="pre">mongoimport</span></tt></a> to load this data set into your
<a class="reference internal" href="http://docs.mongodb.org/manual/reference/mongod/#mongod" title="mongod"><tt class="xref mongodb mongodb-program docutils literal"><span class="pre">mongod</span></tt></a> instance.</p>
<div class="section" id="data-model">
<h3>Data Model<a class="headerlink" href="#data-model" title="Permalink to this headline">¶</a></h3>
<p>Each document in this collection has the following form:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"_id"</span><span class="o">:</span> <span class="s2">"10280"</span><span class="p">,</span>
  <span class="s2">"city"</span><span class="o">:</span> <span class="s2">"NEW YORK"</span><span class="p">,</span>
  <span class="s2">"state"</span><span class="o">:</span> <span class="s2">"NY"</span><span class="p">,</span>
  <span class="s2">"pop"</span><span class="o">:</span> <span class="mi">5574</span><span class="p">,</span>
  <span class="s2">"loc"</span><span class="o">:</span> <span class="p">[</span>
    <span class="o">-</span><span class="mf">74.016323</span><span class="p">,</span>
    <span class="mf">40.710537</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In these documents:</p>
<ul class="simple">
<li>The <tt class="docutils literal"><span class="pre">_id</span></tt> field holds the zipcode as a string.</li>
<li>The <tt class="docutils literal"><span class="pre">city</span></tt> field holds the city.</li>
<li>The <tt class="docutils literal"><span class="pre">state</span></tt> field holds the two letter state abbreviation.</li>
<li>The <tt class="docutils literal"><span class="pre">pop</span></tt> field holds the population.</li>
<li>The <tt class="docutils literal"><span class="pre">loc</span></tt> field holds the location as a latitude longitude pair.</li>
</ul>
<p>All of the following examples use the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/method/db.collection.aggregate/#db.collection.aggregate" title="db.collection.aggregate"><tt class="xref mongodb mongodb-method docutils literal"><span class="pre">aggregate()</span></tt></a> helper in the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/mongo/#mongo" title="mongo"><tt class="xref mongodb mongodb-program docutils literal"><span class="pre">mongo</span></tt></a>
shell. <a class="reference internal" href="http://docs.mongodb.org/manual/reference/method/db.collection.aggregate/#db.collection.aggregate" title="db.collection.aggregate"><tt class="xref mongodb mongodb-method docutils literal"><span class="pre">aggregate()</span></tt></a> provides a
wrapper around the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/command/aggregate/#aggregate" title="aggregate"><tt class="xref mongodb mongodb-dbcommand docutils literal"><span class="pre">aggregate</span></tt></a> database command. See the
documentation for your <a class="reference internal" href="http://docs.mongodb.org/manual/applications/drivers/"><em>driver</em></a> for a
more idiomatic interface for data aggregation operations.</p>
</div>
<div class="section" id="states-with-populations-over-10-million">
<h3>States with Populations Over 10 Million<a class="headerlink" href="#states-with-populations-over-10-million" title="Permalink to this headline">¶</a></h3>
<p>To return all states with a population greater than 10 million, use
the following aggregation operation:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">zipcodes</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span> <span class="p">{</span> <span class="nx">$group</span> <span class="o">:</span>
                         <span class="p">{</span> <span class="nx">_id</span> <span class="o">:</span> <span class="s2">"$state"</span><span class="p">,</span>
                           <span class="nx">totalPop</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">$sum</span> <span class="o">:</span> <span class="s2">"$pop"</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
                       <span class="p">{</span> <span class="nx">$match</span> <span class="o">:</span> <span class="p">{</span><span class="nx">totalPop</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">$gte</span> <span class="o">:</span> <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
<p>Aggregations operations using the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/method/db.collection.aggregate/#db.collection.aggregate" title="db.collection.aggregate"><tt class="xref mongodb mongodb-method docutils literal"><span class="pre">aggregate()</span></tt></a> helper, process all documents on the
<tt class="docutils literal"><span class="pre">zipcodes</span></tt> collection. <a class="reference internal" href="http://docs.mongodb.org/manual/reference/method/db.collection.aggregate/#db.collection.aggregate" title="db.collection.aggregate"><tt class="xref mongodb mongodb-method docutils literal"><span class="pre">aggregate()</span></tt></a> a number of <a class="reference internal" href="http://docs.mongodb.org/manual/applications/aggregation/#aggregation-pipelines"><em>pipeline</em></a> operators that define the aggregation
process.</p>
<p>In the above example, the pipeline passes all documents in the
<tt class="docutils literal"><span class="pre">zipcodes</span></tt> collection through the following steps:</p>
<ul>
<li><p class="first">the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> operator collects all documents and
creates documents for each state.</p>
<p>These new per-state documents have one field in addition the
<tt class="docutils literal"><span class="pre">_id</span></tt> field: <tt class="docutils literal"><span class="pre">totalPop</span></tt> which is a generated field using the
<a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/sum/#_S_sum" title="$sum"><tt class="xref agg agg-expression docutils literal"><span class="pre">$sum</span></tt></a> operation to calculate the total value of all
<tt class="docutils literal"><span class="pre">pop</span></tt> fields in the source documents.</p>
<p>After the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> operation the documents in the
pipeline resemble the following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"_id"</span> <span class="o">:</span> <span class="s2">"AK"</span><span class="p">,</span>
  <span class="s2">"totalPop"</span> <span class="o">:</span> <span class="mi">550043</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/match/#_S_match" title="$match"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$match</span></tt></a> operation filters these documents so that
the only documents that remain are those where the value of
<tt class="docutils literal"><span class="pre">totalPop</span></tt> is greater than or equal to 10 million.</p>
<p>The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/match/#_S_match" title="$match"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$match</span></tt></a> operation does not alter the documents,
which have the same format as the documents output by
<a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a>.</p>
</li>
</ul>
<p>The equivalent <a class="reference internal" href="http://docs.mongodb.org/manual/reference/glossary/#term-sql"><em class="xref std std-term">SQL</em></a> for this operation is:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="k">state</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">pop</span><span class="p">)</span> <span class="k">AS</span> <span class="n">pop</span>
       <span class="k">FROM</span> <span class="n">zips</span>
       <span class="k">GROUP</span> <span class="k">BY</span> <span class="k">state</span>
       <span class="k">HAVING</span> <span class="n">pop</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="average-city-population-by-state">
<h3>Average City Population by State<a class="headerlink" href="#average-city-population-by-state" title="Permalink to this headline">¶</a></h3>
<p>To return the average populations for cities in each state, use the
following aggregation operation:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">zipcodes</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span> <span class="p">{</span> <span class="nx">$group</span> <span class="o">:</span>
                         <span class="p">{</span> <span class="nx">_id</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">state</span> <span class="o">:</span> <span class="s2">"$state"</span><span class="p">,</span> <span class="nx">city</span> <span class="o">:</span> <span class="s2">"$city"</span> <span class="p">},</span>
                           <span class="nx">pop</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">$sum</span> <span class="o">:</span> <span class="s2">"$pop"</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
                       <span class="p">{</span> <span class="nx">$group</span> <span class="o">:</span>
                       <span class="p">{</span> <span class="nx">_id</span> <span class="o">:</span> <span class="s2">"$_id.state"</span><span class="p">,</span>
                         <span class="nx">avgCityPop</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">$avg</span> <span class="o">:</span> <span class="s2">"$pop"</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
<p>Aggregations operations using the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/method/db.collection.aggregate/#db.collection.aggregate" title="db.collection.aggregate"><tt class="xref mongodb mongodb-method docutils literal"><span class="pre">aggregate()</span></tt></a> helper, process all documents on the
<tt class="docutils literal"><span class="pre">zipcodes</span></tt> collection. <a class="reference internal" href="http://docs.mongodb.org/manual/reference/method/db.collection.aggregate/#db.collection.aggregate" title="db.collection.aggregate"><tt class="xref mongodb mongodb-method docutils literal"><span class="pre">aggregate()</span></tt></a> a number of <a class="reference internal" href="http://docs.mongodb.org/manual/applications/aggregation/#aggregation-pipelines"><em>pipeline</em></a> operators that define the aggregation
process.</p>
<p>In the above example, the pipeline passes all documents in the
<tt class="docutils literal"><span class="pre">zipcodes</span></tt> collection through the following steps:</p>
<ul>
<li><p class="first">the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> operator collects all documents and
creates new documents for every combination of the <tt class="docutils literal"><span class="pre">city</span></tt> and
<tt class="docutils literal"><span class="pre">state</span></tt> fields in the source document.</p>
<p>After this stage in the pipeline, the documents resemble the
following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"_id"</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s2">"state"</span> <span class="o">:</span> <span class="s2">"CO"</span><span class="p">,</span>
    <span class="s2">"city"</span> <span class="o">:</span> <span class="s2">"EDGEWATER"</span>
  <span class="p">},</span>
  <span class="s2">"pop"</span> <span class="o">:</span> <span class="mi">13154</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">the second <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> operator collects documents by the
<tt class="docutils literal"><span class="pre">state</span></tt> field and use the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/avg/#_S_avg" title="$avg"><tt class="xref agg agg-expression docutils literal"><span class="pre">$avg</span></tt></a> expression to
compute a value for the <tt class="docutils literal"><span class="pre">avgCityPop</span></tt> field.</p>
</li>
</ul>
<p>The final output of this aggregation operation is:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"_id"</span> <span class="o">:</span> <span class="s2">"MN"</span><span class="p">,</span>
  <span class="s2">"avgCityPop"</span> <span class="o">:</span> <span class="mi">5335</span>
<span class="p">},</span>
</pre></div>
</div>
</div>
<div class="section" id="largest-and-smallest-cities-by-state">
<h3>Largest and Smallest Cities by State<a class="headerlink" href="#largest-and-smallest-cities-by-state" title="Permalink to this headline">¶</a></h3>
<p>To return the smallest and largest cities by population for each
state, use the following aggregation operation:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">zipcodes</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span> <span class="p">{</span> <span class="nx">$group</span><span class="o">:</span>
                         <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">state</span><span class="o">:</span> <span class="s2">"$state"</span><span class="p">,</span> <span class="nx">city</span><span class="o">:</span> <span class="s2">"$city"</span> <span class="p">},</span>
                           <span class="nx">pop</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$sum</span><span class="o">:</span> <span class="s2">"$pop"</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
                       <span class="p">{</span> <span class="nx">$sort</span><span class="o">:</span> <span class="p">{</span> <span class="nx">pop</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
                       <span class="p">{</span> <span class="nx">$group</span><span class="o">:</span>
                         <span class="p">{</span> <span class="nx">_id</span> <span class="o">:</span> <span class="s2">"$_id.state"</span><span class="p">,</span>
                           <span class="nx">biggestCity</span><span class="o">:</span>  <span class="p">{</span> <span class="nx">$last</span><span class="o">:</span> <span class="s2">"$_id.city"</span> <span class="p">},</span>
                           <span class="nx">biggestPop</span><span class="o">:</span>   <span class="p">{</span> <span class="nx">$last</span><span class="o">:</span> <span class="s2">"$pop"</span> <span class="p">},</span>
                           <span class="nx">smallestCity</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$first</span><span class="o">:</span> <span class="s2">"$_id.city"</span> <span class="p">},</span>
                           <span class="nx">smallestPop</span><span class="o">:</span>  <span class="p">{</span> <span class="nx">$first</span><span class="o">:</span> <span class="s2">"$pop"</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>

                       <span class="c1">// the following $project is optional, and</span>
                       <span class="c1">// modifies the output format.</span>

                       <span class="p">{</span> <span class="nx">$project</span><span class="o">:</span>
                         <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="nx">state</span><span class="o">:</span> <span class="s2">"$_id"</span><span class="p">,</span>
                           <span class="nx">biggestCity</span><span class="o">:</span>  <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">"$biggestCity"</span><span class="p">,</span>  <span class="nx">pop</span><span class="o">:</span> <span class="s2">"$biggestPop"</span> <span class="p">},</span>
                           <span class="nx">smallestCity</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">"$smallestCity"</span><span class="p">,</span> <span class="nx">pop</span><span class="o">:</span> <span class="s2">"$smallestPop"</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
<p>Aggregations operations using the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/method/db.collection.aggregate/#db.collection.aggregate" title="db.collection.aggregate"><tt class="xref mongodb mongodb-method docutils literal"><span class="pre">aggregate()</span></tt></a> helper, process all documents on the
<tt class="docutils literal"><span class="pre">zipcodes</span></tt> collection. <a class="reference internal" href="http://docs.mongodb.org/manual/reference/method/db.collection.aggregate/#db.collection.aggregate" title="db.collection.aggregate"><tt class="xref mongodb mongodb-method docutils literal"><span class="pre">aggregate()</span></tt></a> a number of <a class="reference internal" href="http://docs.mongodb.org/manual/applications/aggregation/#aggregation-pipelines"><em>pipeline</em></a> operators that define the aggregation
process.</p>
<p>All documents from the <tt class="docutils literal"><span class="pre">zipcodes</span></tt> collection pass into the pipeline,
which consists of the following steps:</p>
<ul>
<li><p class="first">the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> operator collects all documents and
creates new documents for every combination of the <tt class="docutils literal"><span class="pre">city</span></tt> and
<tt class="docutils literal"><span class="pre">state</span></tt> fields in the source documents.</p>
<p>By specifying the value of <tt class="docutils literal"><span class="pre">_id</span></tt> as a sub-document that contains
both fields, the operation preserves the <tt class="docutils literal"><span class="pre">state</span></tt> field for use
later in the pipeline. The documents produced by this stage of the
pipeline have a second field, <tt class="docutils literal"><span class="pre">pop</span></tt>, which uses the
<a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/sum/#_S_sum" title="$sum"><tt class="xref agg agg-expression docutils literal"><span class="pre">$sum</span></tt></a> operator to provide the total of the <tt class="docutils literal"><span class="pre">pop</span></tt>
fields in the source document.</p>
<p>At this stage in the pipeline, the documents resemble the following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"_id"</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s2">"state"</span> <span class="o">:</span> <span class="s2">"CO"</span><span class="p">,</span>
    <span class="s2">"city"</span> <span class="o">:</span> <span class="s2">"EDGEWATER"</span>
  <span class="p">},</span>
  <span class="s2">"pop"</span> <span class="o">:</span> <span class="mi">13154</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/sort/#_S_sort" title="$sort"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$sort</span></tt></a> operator orders the documents in the pipeline
based on the vale of the <tt class="docutils literal"><span class="pre">pop</span></tt> field from largest to
smallest. This operation does not alter the documents.</p>
</li>
<li><p class="first">the second <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> operator collects the documents in
the pipeline by the <tt class="docutils literal"><span class="pre">state</span></tt> field, which is a field inside the
nested <tt class="docutils literal"><span class="pre">_id</span></tt> document.</p>
<p>Within each per-state document this <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> operator
specifies four fields: Using the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/last/#_S_last" title="$last"><tt class="xref agg agg-expression docutils literal"><span class="pre">$last</span></tt></a> expression,
the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> operator creates the <tt class="docutils literal"><span class="pre">biggestcity</span></tt> and
<tt class="docutils literal"><span class="pre">biggestpop</span></tt> fields that store the city with the largest
population and that population. Using the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/first/#_S_first" title="$first"><tt class="xref agg agg-expression docutils literal"><span class="pre">$first</span></tt></a>
expression, the <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> operator creates the
<tt class="docutils literal"><span class="pre">smallestcity</span></tt> and <tt class="docutils literal"><span class="pre">smallestpop</span></tt> fields that store the city with
the smallest population and that population.</p>
<p>The documents, at this stage in the pipeline resemble the following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"_id"</span> <span class="o">:</span> <span class="s2">"WA"</span><span class="p">,</span>
  <span class="s2">"biggestCity"</span> <span class="o">:</span> <span class="s2">"SEATTLE"</span><span class="p">,</span>
  <span class="s2">"biggestPop"</span> <span class="o">:</span> <span class="mi">520096</span><span class="p">,</span>
  <span class="s2">"smallestCity"</span> <span class="o">:</span> <span class="s2">"BENGE"</span><span class="p">,</span>
  <span class="s2">"smallestPop"</span> <span class="o">:</span> <span class="mi">2</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">The final operation is <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/project/#_S_project" title="$project"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$project</span></tt></a>, which renames the
<tt class="docutils literal"><span class="pre">_id</span></tt> field to <tt class="docutils literal"><span class="pre">state</span></tt> and moves the <tt class="docutils literal"><span class="pre">biggestCity</span></tt>,
<tt class="docutils literal"><span class="pre">biggestPop</span></tt>, <tt class="docutils literal"><span class="pre">smallestCity</span></tt>, and <tt class="docutils literal"><span class="pre">smallestPop</span></tt> into
<tt class="docutils literal"><span class="pre">biggestCity</span></tt> and <tt class="docutils literal"><span class="pre">smallestCity</span></tt> sub-documents.</p>
</li>
</ul>
<p>The final output of this aggregation operation is:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"state"</span> <span class="o">:</span> <span class="s2">"RI"</span><span class="p">,</span>
  <span class="s2">"biggestCity"</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s2">"name"</span> <span class="o">:</span> <span class="s2">"CRANSTON"</span><span class="p">,</span>
    <span class="s2">"pop"</span> <span class="o">:</span> <span class="mi">176404</span>
  <span class="p">},</span>
  <span class="s2">"smallestCity"</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s2">"name"</span> <span class="o">:</span> <span class="s2">"CLAYVILLE"</span><span class="p">,</span>
    <span class="s2">"pop"</span> <span class="o">:</span> <span class="mi">45</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="aggregation-with-user-preference-data">
<h2>Aggregation with User Preference Data<a class="headerlink" href="#aggregation-with-user-preference-data" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>Data Model<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Consider a hypothetical sports club with a database that contains a
<tt class="docutils literal"><span class="pre">user</span></tt> collection that tracks user’s join dates, sport preferences,
and stores these data in documents that resemble the following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="nx">_id</span> <span class="o">:</span> <span class="s2">"jane"</span><span class="p">,</span>
  <span class="nx">joined</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">"2011-03-02"</span><span class="p">),</span>
  <span class="nx">likes</span> <span class="o">:</span> <span class="p">[</span><span class="s2">"golf"</span><span class="p">,</span> <span class="s2">"racquetball"</span><span class="p">]</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="nx">_id</span> <span class="o">:</span> <span class="s2">"joe"</span><span class="p">,</span>
  <span class="nx">joined</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">"2012-07-02"</span><span class="p">),</span>
  <span class="nx">likes</span> <span class="o">:</span> <span class="p">[</span><span class="s2">"tennis"</span><span class="p">,</span> <span class="s2">"golf"</span><span class="p">,</span> <span class="s2">"swimming"</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="normalize-and-sort-documents">
<h3>Normalize and Sort Documents<a class="headerlink" href="#normalize-and-sort-documents" title="Permalink to this headline">¶</a></h3>
<p>The following operation returns user names in upper case and in
alphabetical order. The aggregation includes user names for all documents in
the <tt class="docutils literal"><span class="pre">users</span></tt> collection. You might do this to normalize user names for
processing.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span>
  <span class="p">[</span>
    <span class="p">{</span> <span class="nx">$project</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span><span class="p">{</span><span class="nx">$toUpper</span><span class="o">:</span><span class="s2">"$_id"</span><span class="p">}</span> <span class="p">,</span> <span class="nx">_id</span><span class="o">:</span><span class="mi">0</span> <span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nx">$sort</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">name</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>All documents from the <tt class="docutils literal"><span class="pre">users</span></tt> collection passes through the
pipeline, which consists of the following operations:</p>
<ul class="simple">
<li>The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/project/#_S_project" title="$project"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$project</span></tt></a> operator:<ul>
<li>creates a new field called <tt class="docutils literal"><span class="pre">name</span></tt>.</li>
<li>converts the value of the <tt class="docutils literal"><span class="pre">_id</span></tt> to upper case, with the
<a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/toUpper/#_S_toUpper" title="$toUpper"><tt class="xref agg agg-expression docutils literal"><span class="pre">$toUpper</span></tt></a> operator. Then the
<a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/project/#_S_project" title="$project"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$project</span></tt></a> creates a new filed, named <tt class="docutils literal"><span class="pre">name</span></tt>
to hold this value.</li>
<li>suppresses the <tt class="docutils literal"><span class="pre">id</span></tt> field. <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/project/#_S_project" title="$project"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$project</span></tt></a> will pass
the <tt class="docutils literal"><span class="pre">_id</span></tt> field by default, unless explicitly suppressed.</li>
</ul>
</li>
<li>The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/sort/#_S_sort" title="$sort"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$sort</span></tt></a> operator orders the results by the
<tt class="docutils literal"><span class="pre">name</span></tt> field.</li>
</ul>
<p>The results of the aggregation would resemble the following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"name"</span> <span class="o">:</span> <span class="s2">"JANE"</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">"name"</span> <span class="o">:</span> <span class="s2">"JILL"</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">"name"</span> <span class="o">:</span> <span class="s2">"JOE"</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="return-usernames-ordered-by-join-month">
<h3>Return Usernames Ordered by Join Month<a class="headerlink" href="#return-usernames-ordered-by-join-month" title="Permalink to this headline">¶</a></h3>
<p>The following aggregation operation returns user names sorted by the
month they joined. This kind of aggregation could help generate
membership renewal notices.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span>
  <span class="p">[</span>
    <span class="p">{</span> <span class="nx">$project</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">month_joined</span> <span class="o">:</span> <span class="p">{</span>
                                    <span class="nx">$month</span> <span class="o">:</span> <span class="s2">"$joined"</span>
                                  <span class="p">},</span>
                   <span class="nx">name</span> <span class="o">:</span> <span class="s2">"$_id"</span><span class="p">,</span>
                   <span class="nx">_id</span> <span class="o">:</span> <span class="mi">0</span>
                 <span class="p">},</span>
    <span class="p">{</span> <span class="nx">$sort</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">month_joined</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The pipeline passes all documents in the <tt class="docutils literal"><span class="pre">users</span></tt> collection through
the following operations:</p>
<ul class="simple">
<li>The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/project/#_S_project" title="$project"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$project</span></tt></a> operator:<ul>
<li>Creates two new fields: <tt class="docutils literal"><span class="pre">month_joined</span></tt> and <tt class="docutils literal"><span class="pre">name</span></tt>.</li>
<li>Suppresses the <tt class="docutils literal"><span class="pre">id</span></tt> from the results. The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/method/db.collection.aggregate/#db.collection.aggregate" title="db.collection.aggregate"><tt class="xref mongodb mongodb-method docutils literal"><span class="pre">aggregate()</span></tt></a> method includes the <tt class="docutils literal"><span class="pre">_id</span></tt>, unless
explicitly suppressed.</li>
</ul>
</li>
<li>The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/month/#_S_month" title="$month"><tt class="xref agg agg-expression docutils literal"><span class="pre">$month</span></tt></a> operator converts the values of the
<tt class="docutils literal"><span class="pre">joined</span></tt> field to integer representations of the month. Then the
<a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/project/#_S_project" title="$project"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$project</span></tt></a> operator assigns those values to the
<tt class="docutils literal"><span class="pre">month_joined</span></tt> field.</li>
<li>The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/sort/#_S_sort" title="$sort"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$sort</span></tt></a> operator sorts the results by the
<tt class="docutils literal"><span class="pre">month_joined</span></tt> field.</li>
</ul>
<p>The operation returns results that resemble the following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"month_joined"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">"name"</span> <span class="o">:</span> <span class="s2">"ruth"</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">"month_joined"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">"name"</span> <span class="o">:</span> <span class="s2">"harold"</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">"month_joined"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">"name"</span> <span class="o">:</span> <span class="s2">"kate"</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="s2">"month_joined"</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="s2">"name"</span> <span class="o">:</span> <span class="s2">"jill"</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="return-total-number-of-joins-per-month">
<h3>Return Total Number of Joins per Month<a class="headerlink" href="#return-total-number-of-joins-per-month" title="Permalink to this headline">¶</a></h3>
<p>The following operation shows how many people joined each month of the
year. You might use this aggregated data for such information for recruiting and marketing
strategies.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span>
  <span class="p">[</span>
    <span class="p">{</span> <span class="nx">$project</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">month_joined</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">$month</span> <span class="o">:</span> <span class="s2">"$joined"</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">,</span>
    <span class="p">{</span> <span class="nx">$group</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">_id</span> <span class="o">:</span> <span class="p">{</span><span class="nx">month_joined</span><span class="o">:</span><span class="s2">"$month_joined"</span><span class="p">}</span> <span class="p">,</span> <span class="nx">number</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">$sum</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nx">$sort</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">"_id.month_joined"</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The pipeline passes all documents in the <tt class="docutils literal"><span class="pre">users</span></tt> collection through
the following operations:</p>
<ul class="simple">
<li>The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/project/#_S_project" title="$project"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$project</span></tt></a> operator creates a new field called
<tt class="docutils literal"><span class="pre">month_joined</span></tt>.</li>
<li>The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/month/#_S_month" title="$month"><tt class="xref agg agg-expression docutils literal"><span class="pre">$month</span></tt></a> operator converts the values of the
<tt class="docutils literal"><span class="pre">joined</span></tt> field to integer representations of the month. Then the
<a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/project/#_S_project" title="$project"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$project</span></tt></a> operator assigns the values to the
<tt class="docutils literal"><span class="pre">month_joined</span></tt> field.</li>
<li>The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> operator collects all documents with a
given <tt class="docutils literal"><span class="pre">month_joined</span></tt> value and counts how many documents there are
for that value. Specifically, for each unique value,
<a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> creates a new “per-month” document with two
fields:<ul>
<li><tt class="docutils literal"><span class="pre">_id</span></tt>, which contains a nested document with the
<tt class="docutils literal"><span class="pre">month_joined</span></tt> field and its value.</li>
<li><tt class="docutils literal"><span class="pre">number</span></tt>, which is a generated field. The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/sum/#_S_sum" title="$sum"><tt class="xref agg agg-expression docutils literal"><span class="pre">$sum</span></tt></a>
operator increments this field by 1 for every document containing
the given <tt class="docutils literal"><span class="pre">month_joined</span></tt> value.</li>
</ul>
</li>
<li>The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/sort/#_S_sort" title="$sort"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$sort</span></tt></a> operator sorts the documents created by
<a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> according to the contents of the
<tt class="docutils literal"><span class="pre">month_joined</span></tt> field.</li>
</ul>
<p>The result of this aggregation operation would resemble the following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"_id"</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s2">"month_joined"</span> <span class="o">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="s2">"number"</span> <span class="o">:</span> <span class="mi">3</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">"_id"</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s2">"month_joined"</span> <span class="o">:</span> <span class="mi">2</span>
  <span class="p">},</span>
  <span class="s2">"number"</span> <span class="o">:</span> <span class="mi">9</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">"_id"</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s2">"month_joined"</span> <span class="o">:</span> <span class="mi">3</span>
  <span class="p">},</span>
  <span class="s2">"number"</span> <span class="o">:</span> <span class="mi">5</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="return-the-five-most-common-likes">
<h3>Return the Five Most Common “Likes”<a class="headerlink" href="#return-the-five-most-common-likes" title="Permalink to this headline">¶</a></h3>
<p>The following aggregation collects top five most “liked” activities in
the data set. In this data set, you might use an analysis of this to
help inform planning and future development.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span>
  <span class="p">[</span>
    <span class="p">{</span> <span class="nx">$unwind</span> <span class="o">:</span> <span class="s2">"$likes"</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nx">$group</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">_id</span> <span class="o">:</span> <span class="s2">"$likes"</span> <span class="p">,</span> <span class="nx">number</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">$sum</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nx">$sort</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">number</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nx">$limit</span> <span class="o">:</span> <span class="mi">5</span> <span class="p">}</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The pipeline begins with all documents in the <tt class="docutils literal"><span class="pre">users</span></tt> collection,
and passes these documents through the following operations:</p>
<ul>
<li><p class="first">The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/unwind/#_S_unwind" title="$unwind"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$unwind</span></tt></a> operator separates each value in the
<tt class="docutils literal"><span class="pre">likes</span></tt> array, and creates a new version of the source document
for every element in the array.</p>
<div class="admonition-example admonition">
<p class="first admonition-title">Example</p>
<p>Given the following document from the <tt class="docutils literal"><span class="pre">users</span></tt> collection:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="nx">_id</span> <span class="o">:</span> <span class="s2">"jane"</span><span class="p">,</span>
  <span class="nx">joined</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">"2011-03-02"</span><span class="p">),</span>
  <span class="nx">likes</span> <span class="o">:</span> <span class="p">[</span><span class="s2">"golf"</span><span class="p">,</span> <span class="s2">"racquetball"</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/unwind/#_S_unwind" title="$unwind"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$unwind</span></tt></a> operator would create the following
documents:</p>
<div class="last highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="nx">_id</span> <span class="o">:</span> <span class="s2">"jane"</span><span class="p">,</span>
  <span class="nx">joined</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">"2011-03-02"</span><span class="p">),</span>
  <span class="nx">likes</span> <span class="o">:</span> <span class="s2">"golf"</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="nx">_id</span> <span class="o">:</span> <span class="s2">"jane"</span><span class="p">,</span>
  <span class="nx">joined</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">"2011-03-02"</span><span class="p">),</span>
  <span class="nx">likes</span> <span class="o">:</span> <span class="s2">"racquetball"</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</li>
<li><p class="first">The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> operator collects all documents the same
value for the <tt class="docutils literal"><span class="pre">likes</span></tt> field and counts each grouping. With this
information, <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/group/#_S_group" title="$group"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$group</span></tt></a> creates a new document with two
fields:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">_id</span></tt>, which contains the <tt class="docutils literal"><span class="pre">likes</span></tt> value.</li>
<li><tt class="docutils literal"><span class="pre">number</span></tt>, which is a generated field. The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/sum/#_S_sum" title="$sum"><tt class="xref agg agg-expression docutils literal"><span class="pre">$sum</span></tt></a>
operator increments this field by 1 for every document containing
the given <tt class="docutils literal"><span class="pre">likes</span></tt> value.</li>
</ul>
</li>
<li><p class="first">The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/sort/#_S_sort" title="$sort"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$sort</span></tt></a> operator sorts these documents by the
<tt class="docutils literal"><span class="pre">number</span></tt> field in reverse order.</p>
</li>
<li><p class="first">The <a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/limit/#_S_limit" title="$limit"><tt class="xref agg agg-pipeline docutils literal"><span class="pre">$limit</span></tt></a> operator only includes the first 5 result
documents.</p>
</li>
</ul>
<p>The results of aggregation would resemble the following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">"_id"</span> <span class="o">:</span> <span class="s2">"golf"</span><span class="p">,</span>
  <span class="s2">"number"</span> <span class="o">:</span> <span class="mi">33</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">"_id"</span> <span class="o">:</span> <span class="s2">"racquetball"</span><span class="p">,</span>
  <span class="s2">"number"</span> <span class="o">:</span> <span class="mi">31</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">"_id"</span> <span class="o">:</span> <span class="s2">"swimming"</span><span class="p">,</span>
  <span class="s2">"number"</span> <span class="o">:</span> <span class="mi">24</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">"_id"</span> <span class="o">:</span> <span class="s2">"handball"</span><span class="p">,</span>
  <span class="s2">"number"</span> <span class="o">:</span> <span class="mi">19</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">"_id"</span> <span class="o">:</span> <span class="s2">"tennis"</span><span class="p">,</span>
  <span class="s2">"number"</span> <span class="o">:</span> <span class="mi">18</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>


<div id="btnv">
<ul id="btnvl">
<li id="btnvpr"><a href="http://docs.mongodb.org/manual/applications/aggregation/" title="Previous Section: Aggregation Framework">&lt; &nbsp; Aggregation Framework</a></li>
<li id="btnvup"><a href="http://docs.mongodb.org/manual/aggregation/" title="Parent Section: Aggregation">/\&nbsp; Aggregation</a></li>
<li id="btnvnx"><a href="http://docs.mongodb.org/manual/reference/aggregation/" title="Next Section: Aggregation Framework Reference">Aggregation Framework Reference &nbsp;&gt;</a></li>
</ul>
</div>
</div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><h3><a href="http://docs.mongodb.org/manual/contents/">MongoDB Manual</a>

<small><a href="http://docs.mongodb.org/manual/genindex/">(Index)</a></small>

</h3>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/installation/">Installing MongoDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/administration/">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/crud/">Core MongoDB Operations (CRUD)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="http://docs.mongodb.org/manual/aggregation/">Aggregation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/manual/applications/aggregation/">Aggregation Framework</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Aggregation Framework Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#aggregations-using-the-zip-code-data-set">Aggregations using the Zip Code Data Set</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#data-model">Data Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#states-with-populations-over-10-million">States with Populations Over 10 Million</a></li>
<li class="toctree-l4"><a class="reference internal" href="#average-city-population-by-state">Average City Population by State</a></li>
<li class="toctree-l4"><a class="reference internal" href="#largest-and-smallest-cities-by-state">Largest and Smallest Cities by State</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#aggregation-with-user-preference-data">Aggregation with User Preference Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Data Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#normalize-and-sort-documents">Normalize and Sort Documents</a></li>
<li class="toctree-l4"><a class="reference internal" href="#return-usernames-ordered-by-join-month">Return Usernames Ordered by Join Month</a></li>
<li class="toctree-l4"><a class="reference internal" href="#return-total-number-of-joins-per-month">Return Total Number of Joins per Month</a></li>
<li class="toctree-l4"><a class="reference internal" href="#return-the-five-most-common-likes">Return the Five Most Common “Likes”</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/manual/reference/aggregation/">Aggregation Framework Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/manual/applications/map-reduce/">Map-Reduce</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://docs.mongodb.org/manual/reference/simple-aggregation/">Simple Aggregation Methods and Commands</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/indexes/">Indexes</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/replication/">Replication</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/sharding/">Sharding</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/applications/">Application Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/mongo/">Using the <tt class="docutils literal"><span class="pre">mongo</span></tt> Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/use-cases/">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/tutorial/">MongoDB Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/faq/">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/reference/">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://docs.mongodb.org/manual/about/">About MongoDB Documentation</a></li>
</ul>

<h3 style="padding-bottom: 1em;"><a href="http://www.mongodb.org/about/">MongoDB.org</a></h3>
<h3 style="padding-bottom: 1em;"><a href="http://docs.mongodb.org/ecosystem/">MongoDB Ecosystem</a></h3><h3>Formats</h3>
<ul class="this-page-menu">
  <li><a href="http://docs.mongodb.org/master/single/">MongoDB Manual, Single HTML Page</a></li>
  <li><a href="http://docs.mongodb.org/master/MongoDB-Manual-master.pdf" rel="nofollow">MongoDB Manual, PDF Format</a></li>
  <li><a href="http://docs.mongodb.org/master/MongoDB-Manual-master.epub" rel="nofollow">MongoDB Manual, ePub Format</a></li>
</ul><h3>MongoDB Resources</h3>

<ul>
 <li><strong>Getting Started</strong>
   <ul>
     <li><a href="http://www.mongodb.org/about/introduction">Introduction</a></li>
     <li><a href="http://www.mongodb.org/downloads">Downloads</a></li>
   </ul>
 </li>
 <li><strong><a href="http://www.mongodb.org/about/community">Community</a> and <a href="http://docs.mongodb.org/ecosystem/">Ecosystem</a></strong>
   <ul>
     <li><a href="http://www.10gen.com/">10gen</a></li>
     <li><a href="http://www.10gen.com/events">MongoDB Events</a></li>
     <li><a href="http://planet.mongodb.org/">Planet MongoDB</a></li>
     <li><a href="http://mongodb.org/about/community/masters">MongoDB Masters</a></li>
     <li><a href="http://www.10gen.com/presentations">Slides and Video</a></li>
     <li><a href="http://docs.mongodb.org/ecosystem/platforms/">Hosting Center</a></li>
     <li><a href="http://docs.mongodb.org/ecosystem/platforms/windows">Windows</a></li>
     <li><a href="http://www.10gen.com/products/mms/">MongoDB Monitoring Service</a> (<a href="http://mms.10gen.com/help/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/tools/administration-interfaces/">Administrative Interfaces</a></li>
     <li><a href="http://www.10gen.com/books/">MongoDB Books</a></li>
   </ul>
 </li>
 <li><strong><a href="http://docs.mongodb.org/ecosystem/drivers/">Drivers</a></strong>
   <ul>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/javascript">JavaScript</a> (<a href="http://api.mongodb.org/js/current">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/python">Python</a> (<a href="http://api.mongodb.org/python/current">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/ruby">Ruby</a> (<a href="http://api.mongodb.org/ruby/current">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/php">PHP</a> (<a href="http://php.net/mongo/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/perl">Perl</a> (<a href="http://api.mongodb.org/perl/current/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/java">Java</a> (<a href="http://api.mongodb.org/java/current">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/scala">Scala</a> (<a href="http://api.mongodb.org/scala/casbah/current/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/csharp">C#</a> (<a href="http://api.mongodb.org/csharp/current/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/c">C</a> (<a href="http://api.mongodb.org/c/current/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/cpp">C++</a> (<a href="http://api.mongodb.org/cplusplus/current/">docs</a>)</li>
     <li><a href="http://hackage.haskell.org/package/mongoDB">Haskell</a> (<a href="http://api.mongodb.org/haskell">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/erlang">Erlang</a> (<a href="http://api.mongodb.org/erlang">docs</a>)</li>
   </ul>
 </li>
</ul>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    <p>
       © <a href="">Copyright</a> 2011-2013, 10gen, Inc. 
       MongoDB®, Mongo®, and the leaf logo are registered trademarks of 10gen, Inc.
    </p>
  </div><script type="text/javascript">
var _gaq = _gaq || [];
var pluginUrl = (('https:' == document.location.protocol) ? 'https://ssl.' : 'http://www.') + 'google-analytics.com/plugins/ga/inpage_linkid.js';
_gaq.push(['_require', 'inpage_linkid', pluginUrl]);
_gaq.push(['_setAccount', 'UA-7301842-8']);
_gaq.push(['_setDomainName', 'docs.mongodb.org']);
_gaq.push(['_trackPageview']);
(function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
        })();
</script>

<script type="text/javascript">
document.write(unescape("%3Cscript src='" + document.location.protocol + "//munchkin.marketo.net/munchkin.js' type='text/javascript'%3E%3C/script%3E"));
</script><script src="Aggregation%20Framework%20Examples%20%E2%80%94%20MongoDB%20Manual_files/munchkin.htm" type="text/javascript"></script>
<script>try { mktoMunchkin("017-HGS-593"); } catch(e) {}</script><script type="text/javascript">
jQuery.ajax({
    url: "https://jira.mongodb.org/s/en_US-bxctp1/782/6/1.2.4/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?collectorId=298ba4e7",
    type: "get",
    cache: true,
    dataType: "script"
});
window.ATL_JQ_PAGE_PROPS =  {
"triggerFunction": function(showCollectorDialog) {
jQuery("#jirafeedback").click(function(e) {e.preventDefault();showCollectorDialog();});
jQuery("#jirafooter").click(function(e) {e.preventDefault();showCollectorDialog();});
}};
</script>

<table class="gstl_0 gssb_c" style="width: 129px; display: none; top: 70px; left: 751px; position: absolute;" cellpadding="0" cellspacing="0"><tbody><tr><td class="gssb_f"></td><td style="width: 100%;" class="gssb_e"></td></tr></tbody></table><div style="display: none;" id="atlwdg-blanket" class="atlwdg-blanket"></div><div class="atlwdg-popup atlwdg-box-shadow atlwdg-hidden" id="atlwdg-container"></div></body></html>